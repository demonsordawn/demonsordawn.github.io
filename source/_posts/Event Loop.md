---
title: "event loop机制?宏任务和微任务的区别"
date: 2025-10-29
tags: [event loop, 事件循环]
---
### 事件循环
#### 基本概念:事件循环是javascript运行时处理异步操作的机制,它让单线程的javascript能够非阻塞地处理多个任务.
#### 事件循环机制:
1. 执行同步代码:同步任务会在调用栈中立即执行
2. 处理异步任务:异步任务(如定时器,I/O操作等),会被分配到任务队列中.任务队列分为宏任务队列和微任务队列
3. 事件循环的循环流程:
   - 从宏任务队列中取出一个任务(最早的那个)执行
   - 执行过程中如果遇到微任务,则将其添加到微任务队列
   - 当当前宏任务执行完毕,会立即依次执行微任务队列中的所有微任务(直到清空微任务队列)
   - 然后再次回到事件循环,继续处理宏任务队列中的下一个任务

### 宏任务
#### 宏任务代表一些离散的,独立的工作单元.每个宏任务都会在完成后让事件循环继续下一个任务
#### 常见的宏任务:
- setTimeout
- setInterval
- setImmdeiate
- I/O操作(如文件读写,网络请求)
- UI渲染(浏览器)
- 事件回调(如点击事件)

### 微任务
#### 微任务是在当前宏任务执行结束后立即执行的任务,它们会在下一个宏任务开始之前执行,并且会在当前事件循环的末尾执行
#### 常见的微任务:
- Promise.then(),Promise.catch(),Promise.finally()
- queueMicrotask()
- MutationObserver(浏览器)
- process.nextTick() (Node.js,注意,在Node.js中,process.nextTick的执行优先级高于其他微任务)

### 关键区别
1. 执行的时机:在当前宏任务执行完毕后,会执行所有的微任务,然后再执行下一个宏任务
2. 优先级:微任务的优先级高于宏任务,事件循环在每次宏任务执行完毕后,会清空微任务队列
3. 任务队列: 宏任务有多个队列(如定时器队列,I/O队列等), 而微任务队列只有一个

### 代码示例
```javascript
console.log('start'); // 同步任务

setTimeout(() => {
  console.log('setTimeout'); // 宏任务
}, 0);

Promise.resolve().then(() => {
  console.log('promise'); // 微任务
});

console.log('end'); // 同步任务

// 输出顺序：
// start
// end
// promise
// setTimeout
```